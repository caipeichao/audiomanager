<foundation id="{$name}cpupload">
    <form action="{:U('widget/CpUpload/upload', array('widget_appname'=>'emomp3'))}" method="post" enctype="multipart/form-data">
        <div class="row">
            <div class="large-offset-3 large-6 columns">
                <input type="file"  name="files[]" accept="audio/*" multiple>
            </div>
        </div>
        <div class="row">
            <div class="large-6 large-offset-3 columns">
                <table id="filelist">
                    <thead>
                    <tr>
                        <th width="250">文件名</th>
                        <th width="80" class="text-right">大小</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>请选择文件</td>
                        <td class="text-right">-</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="row">
            <div class="large-12 large-centered columns text-center">
                <input class="button large" type="submit" value="开始上传"/>
            </div>
        </div>
    </form>
</foundation>

<script>
    $('#{$name}cpupload input[type="file"]').change(function(){
        // gen files html
        var html = "";
        var files = $('#{$name}cpupload input[type="file"]')[0].files;
        for(var i=0;i<files.length;i++){
            var filename = files[i].name;
            var filesize = files[i].size;
            html += "<tr>";
            html += "<td>";
            html += filename;
            html += "</td>";
            html += '<td class="text-right">';
            html += friendlysize(filesize);
            html += "</td>";
            html += "</tr>";
        }
        // show html
        $("#{$name}cpupload #filelist tbody").html(html);
    });

    function friendlysize(filesize) {
        if(filesize < 1024) {
            return filesize + "字节";
        } else if(filesize < 1024*1024) {
            return humanround(filesize / 1024) + "KB";
        } else {
            return humanround(filesize / 1024 / 1024) + "MB";
        }
    }

    function humanround(n) {
        return Math.round(n*10) / 10;
    }

    $('#{$name}cpupload').submit(function(){
        var url = $("#{$name}cpupload form")[0].getAttribute("action");
        $('#{$name}cpupload').ajaxSubmit({url:url, type:'post', success: function(a,b,c){
            if(a.success) {
                ui.success(a.message);
                setTimeout(function(){
                    location.reload();
                }, 500);
            } else {
                ui.error(a.message);
            }
        }});
        return false;
    })
</script>